# Create a worktree from a new or existing branch.
# Sourced from:
# - https://gist.github.com/dhh/18575558fc5ee10f15b6cd3e108ed844
# - https://x.com/dhh/status/2018631575337095389
ga() {
  if [[ -z "$1" ]]; then
    echo "Usage: ga [branch name]"
    return 1
  fi

  local branch="$1"
  local base="$(basename "$PWD")"
  local worktree="../${base}--${branch//\//-}"
  local source_dir="$PWD"

  if git show-ref --verify --quiet "refs/heads/$branch"; then
    # Branch exists locally
    git worktree add "$worktree" "$branch"
  elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
    # Branch exists on remote
    git worktree add --track -b "$branch" "$worktree" "origin/$branch"
  else
    # New branch
    git worktree add -b "$branch" "$worktree"
  fi

  cd "$worktree"

  # Symlink .claude/*.local.* files from source directory
  if [[ -d "${source_dir}/.claude" ]]; then
    local local_files=("${source_dir}"/.claude/*.local.*(N))
    if [[ ${#local_files[@]} -gt 0 ]]; then
      mkdir -p .claude
      for file in "${local_files[@]}"; do
        ln -sf "$file" ".claude/$(basename "$file")"
      done
    fi
  fi
}
