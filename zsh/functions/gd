# Remove worktree and branch from within active worktree directory.
# Sourced from:
# - https://gist.github.com/dhh/18575558fc5ee10f15b6cd3e108ed844
# - https://x.com/dhh/status/2018631575337095389
gd() {
  read "reply?Remove worktree and branch? [y/N] "
  [[ "$reply" =~ ^[Yy]$ ]] || return

  local worktree root branch

  worktree="$(basename "$PWD")"
  root="${worktree%%--*}"

  # Get the branch name from git (handles branches with slashes)
  branch="$(git rev-parse --abbrev-ref HEAD)"

  # Expected worktree suffix (branch with slashes replaced by dashes)
  local expected_suffix="${branch//\//-}"

  # Protect against accidentally nuking a non-worktree directory or wrong branch
  if [[ "$root" == "$worktree" ]]; then
    echo "Error: Not in a worktree directory (missing '--' separator)"
    return 1
  fi

  if [[ -z "$branch" ]]; then
    echo "Error: Could not determine current branch"
    return 1
  fi

  if [[ "$worktree" != "${root}--${expected_suffix}" ]]; then
    echo "Error: Branch '$branch' does not match worktree directory '$worktree'"
    return 1
  fi

  cd "../$root"
  git worktree remove "$worktree" --force
  git branch -D "$branch"
}
